<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Epigenetics: Lick Your Rats</title>
    <style>
        :root {
            /* New Bio-Tech Theme */
            --primary: #4f46e5; /* Indigo */
            --primary-hover: #4338ca;
            --secondary: #0ea5e9; /* Sky Blue */
            --secondary-hover: #0284c7;
            --bg-dark: #0f172a; /* Slate 900 */
            --panel-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            
            /* Accents */
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-pink: #f472b6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: none; /* Prevent iPad pull-to-refresh */
            user-select: none;
            -webkit-user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 1024px;
            height: 100vh;
            max-height: 768px;
            background-color: #f8fafc;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            border-radius: 8px; /* Slight rounding for iPad look */
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid rgba(255,255,255,0.2);
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
        }

        .timer-box {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            display: none; 
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- Screens --- */
        .screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 65px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f1f5f9;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateX(20px);
            padding: 30px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: translateX(0);
        }

        /* --- Common UI Components --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }

        .btn:active { transform: scale(0.95); }
        .btn:hover { background-color: var(--primary-hover); box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3); }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-outline:hover { background-color: rgba(79, 70, 229, 0.1); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: var(--secondary-hover); }

        /* --- Main Menu Screen --- */
        .menu-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .menu-title {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 900;
        }

        .menu-subtitle {
            font-size: 1.3rem;
            color: var(--text-light);
            margin-bottom: 50px;
            max-width: 500px;
            line-height: 1.5;
        }

        .menu-buttons {
            display: flex;
            gap: 20px;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
        }

        .menu-buttons .btn {
            width: 100%;
            padding: 20px;
            font-size: 1.3rem;
        }

        /* --- Learn the Science Screen --- */
        .science-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .slide {
            display: none;
            flex-grow: 1;
            animation: fadeIn 0.4s;
        }

        .slide.active {
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .slide-text { flex: 1; }
        .slide-text h2 { color: var(--primary); font-size: 2.2rem; margin-top: 0; line-height: 1.2; }
        .slide-text p { font-size: 1.25rem; line-height: 1.6; color: var(--text-dark); margin-bottom: 20px; }
        
        /* Slide Graphics Container */
        .slide-graphic {
            flex: 1;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .science-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            border-top: 2px solid #e2e8f0;
            padding-top: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Slide Specific Animations --- */
        /* Slide 1: DNA Glow */
        @keyframes gentleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .anim-dna { animation: gentleFloat 3s ease-in-out infinite; opacity: 0.8; }
        .anim-glow { filter: drop-shadow(0 0 15px var(--secondary)); }
        
        /* Slide 2: Methyl Blocks */
        .static-methyl {
            position: absolute;
            width: 40px; height: 40px;
            background: var(--accent-red);
            border: 3px solid white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .gene-status {
            position: absolute;
            top: 20px; right: 20px;
            background: var(--text-dark); color: white;
            padding: 8px 15px; border-radius: 20px;
            font-weight: bold; font-size: 1.2rem;
        }
        .status-off { background: var(--accent-red); }
        .status-on { background: var(--accent-green); }

        /* Slide 3: Licking Demo */
        @keyframes demoLick {
            0%, 100% { transform: translateX(20px) translateY(-20px) rotate(15deg); }
            50% { transform: translateX(-20px) translateY(0px) rotate(-15deg); }
        }
        @keyframes demoPop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5) translateY(-30px); opacity: 0.5; }
            100% { transform: scale(0) translateY(-60px); opacity: 0; }
        }
        .demo-mom { animation: demoLick 1.5s ease-in-out infinite; }
        .demo-methyl { animation: demoPop 1.5s ease-out infinite; }

        /* --- Game Screen Layout --- */
        .game-layout {
            display: flex;
            height: 100%;
            gap: 30px;
        }

        /* Left Side: Macro (Rat) */
        .macro-panel {
            flex: 1.2;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }

        .instruction-badge {
            position: absolute;
            top: 20px;
            background: var(--primary);
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        /* Mother Rat Area */
        .mother-rat {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-50px);
            width: 150px;
            height: 150px;
            opacity: 0.8;
            transition: transform 0.1s ease-out;
            pointer-events: none;
            z-index: 5;
        }

        /* Pup Area */
        .pup-container {
            width: 300px;
            height: 200px;
            position: relative;
            z-index: 2;
        }

        .pup-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
            transition: transform 0.1s;
        }

        .progress-bar-container {
            width: 80%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            position: absolute;
            bottom: 30px;
            overflow: hidden;
            border: 2px solid #cbd5e1;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-green);
            transition: width 0.1s;
        }

        /* Lick Visuals */
        .lick-visual {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-pink);
            pointer-events: none;
            animation: floatLick 0.6s forwards ease-out;
            z-index: 20;
            text-shadow: 1px 1px 0px white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;
        }

        .saliva-drop {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #93c5fd;
            border-radius: 50% 50% 50% 0;
            transform: rotate(45deg);
            pointer-events: none;
            animation: dropSplash 0.5s forwards ease-out;
            z-index: 19;
            opacity: 0.7;
        }

        @keyframes floatLick {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50px) scale(1); opacity: 0; }
        }

        @keyframes dropSplash {
            0% { transform: rotate(45deg) scale(0.5); opacity: 1; }
            100% { transform: rotate(45deg) scale(2) translateY(20px); opacity: 0; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Right Side: Micro (DNA) */
        .micro-panel {
            flex: 0.8;
            background: var(--bg-dark);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 4px solid #1e293b;
        }

        .micro-header {
            background: #1e293b;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 1px;
            border-bottom: 2px solid #334155;
        }

        .dna-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dna-svg {
            width: 80%;
            height: 90%;
            opacity: 0.5;
            transition: opacity 1s, filter 1s;
        }

        .dna-active {
            opacity: 1;
            filter: drop-shadow(0 0 20px var(--secondary));
        }

        .methyl-group {
            position: absolute;
            width: 45px;
            height: 45px;
            background-color: var(--accent-red);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s, opacity 0.3s;
            z-index: 5;
        }

        @keyframes popOff {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5) translateY(-50px) rotate(20deg); opacity: 0.8; }
            100% { transform: scale(0) translateY(-100px) rotate(45deg); opacity: 0; }
        }
        .popping { animation: popOff 0.5s forwards ease-out; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-2px, -2px) rotate(-2deg); }
            50% { transform: translate(-3px, 0px) rotate(2deg); }
            75% { transform: translate(3px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(0deg); }
        }
        .shaking { animation: shake 0.2s infinite; }

        /* --- Result Screen --- */
        .result-card {
            background: white;
            padding: 50px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            max-width: 600px;
            margin: auto;
            text-align: center;
        }

        .result-card h2 { font-size: 2.5rem; margin-top: 0; }
        .result-card p { font-size: 1.3rem; line-height: 1.6; margin-bottom: 30px; }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Epigenetics: Lick Your Rats</h1>
            <div id="game-timer" class="timer-box">Time: <span id="timer-display">20</span>s</div>
        </header>

        <!-- SCREEN 1: Main Menu -->
        <div id="view-menu" class="screen active">
            <div class="menu-layout">
                <h1 class="menu-title">LICK YOUR RATS</h1>
                <p class="menu-subtitle">An interactive biological simulation demonstrating how maternal care shapes DNA expression.</p>
                
                <div class="menu-buttons">
                    <button class="btn btn-outline" onclick="switchView('view-science')">üìö Learn the Science</button>
                    <button class="btn" onclick="startGame()">üëÖ Play Simulation</button>
                    <a href="index.html" class="btn btn-secondary" style="margin-top: 20px;">üè† Back to Dashboard</a>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: Learn the Science -->
        <div id="view-science" class="screen">
            <div class="science-card">
                
                <!-- Slide 1: Epigenetics -->
                <div class="slide active" id="slide-1">
                    <div class="slide-text">
                        <h2>üß¨ What is Epigenetics?</h2>
                        <p>Think of DNA as the "hardware" of a computer. It contains all the fixed instructions needed to build an organism.</p>
                        <p><strong>Epigenetics</strong> is the "software." It decides which genes are turned ON and which are turned OFF. It doesn't alter the actual DNA sequence, but it changes how the DNA is read by the body.</p>
                    </div>
                    <div class="slide-graphic">
                        <svg class="anim-dna anim-glow" viewBox="0 0 100 200" width="150" height="300" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 20 0 Q 80 50 20 100 T 20 200" fill="none" stroke="var(--primary)" stroke-width="6" />
                            <path d="M 80 0 Q 20 50 80 100 T 80 200" fill="none" stroke="var(--secondary)" stroke-width="6" />
                            <line x1="30" y1="20" x2="70" y2="30" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="45" y1="50" x2="55" y2="50" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="70" y1="70" x2="30" y2="80" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="75" y1="100" x2="25" y2="100" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="70" y1="130" x2="30" y2="120" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="55" y1="150" x2="45" y2="150" stroke="#94a3b8" stroke-width="4"/>
                            <line x1="30" y1="170" x2="70" y2="180" stroke="#94a3b8" stroke-width="4"/>
                        </svg>
                    </div>
                </div>

                <!-- Slide 2: GR Gene -->
                <div class="slide" id="slide-2">
                    <div class="slide-text">
                        <h2>üõë The GR Gene & Methyls</h2>
                        <p>Rats have a gene called the <strong>GR Gene</strong>. When active, it helps the rat relax after a stressful event.</p>
                        <p>However, when a rat pup is born, this gene is naturally turned <strong>OFF</strong>. It is blocked by chemical markers called <strong>Methyl Groups (CH3)</strong> that attach tightly to the DNA strand, preventing it from being read.</p>
                    </div>
                    <div class="slide-graphic">
                        <div class="gene-status status-off">GR GENE: OFF</div>
                        <svg class="anim-dna" viewBox="0 0 100 200" width="150" height="300" xmlns="http://www.w3.org/2000/svg" style="opacity:0.3;">
                            <path d="M 20 0 Q 80 50 20 100 T 20 200" fill="none" stroke="#64748b" stroke-width="6" />
                            <path d="M 80 0 Q 20 50 80 100 T 80 200" fill="none" stroke="#475569" stroke-width="6" />
                        </svg>
                        <div class="static-methyl" style="top: 20%; left: 30%;">CH3</div>
                        <div class="static-methyl" style="top: 40%; left: 60%;">CH3</div>
                        <div class="static-methyl" style="top: 60%; left: 20%;">CH3</div>
                        <div class="static-methyl" style="top: 80%; left: 50%;">CH3</div>
                    </div>
                </div>

                <!-- Slide 3: Licking -->
                <div class="slide" id="slide-3">
                    <div class="slide-text">
                        <h2>üëÖ The Power of Care</h2>
                        <p>Mother rats care for their pups by licking them. This physical, nurturing action sends positive chemical signals to the pup's brain.</p>
                        <p>If the mother licks the pup enough, those signals physically break the Methyl blocks off the DNA. The GR Gene turns <strong>ON</strong>, and the rat grows up calm and resilient!</p>
                    </div>
                    <div class="slide-graphic">
                        <div class="gene-status status-on">GR GENE: ON</div>
                        <svg viewBox="0 0 200 150" width="200" height="150" xmlns="http://www.w3.org/2000/svg" style="position:absolute; bottom:20px;">
                            <ellipse cx="100" cy="80" rx="55" ry="35" fill="#94a3b8" />
                            <ellipse cx="50" cy="75" rx="30" ry="22" fill="#94a3b8" />
                            <circle cx="60" cy="55" r="12" fill="#cbd5e1" />
                            <path d="M 30 70 Q 40 75 50 70" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <!-- Animated Mom -->
                        <svg class="demo-mom" viewBox="0 0 100 100" width="100" height="100" xmlns="http://www.w3.org/2000/svg" style="position:absolute; top:40px; left:40px;">
                            <path d="M 20 0 Q 50 80 80 0" fill="#64748b" />
                            <ellipse cx="35" cy="40" rx="5" ry="8" fill="#1e293b" />
                            <ellipse cx="65" cy="40" rx="5" ry="8" fill="#1e293b" />
                            <circle cx="50" cy="70" r="6" fill="#f472b6" />
                        </svg>
                        <!-- Animated popping methyl -->
                        <div class="static-methyl demo-methyl" style="top: 50%; right: 20%;">CH3</div>
                    </div>
                </div>

                <!-- Navigation Controls -->
                <div style="margin-top: auto;">
                    <div class="science-controls">
                        <button class="btn btn-outline" id="btn-prev" onclick="changeSlide(-1)" style="visibility: hidden;">‚Üê Previous</button>
                        <button class="btn" id="btn-next" onclick="changeSlide(1)">Next ‚Üí</button>
                        <button class="btn btn-secondary" id="btn-play" onclick="startGame()" style="display: none;">Play Simulation üëÖ</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-outline" style="border: none; font-size: 1rem;" onclick="switchView('view-menu')">Return to Menu</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: Simulation (Game) -->
        <div id="view-game" class="screen">
            <div class="game-layout">
                
                <!-- Macro View: The Licking Area -->
                <div class="macro-panel" id="touch-area">
                    <div class="instruction-badge">SWIPE TO LICK!</div>
                    
                    <!-- Mother Rat Head -->
                    <svg class="mother-rat" id="mother-rat" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 20 0 Q 50 80 80 0" fill="#64748b" />
                        <ellipse cx="35" cy="40" rx="5" ry="8" fill="#1e293b" />
                        <ellipse cx="65" cy="40" rx="5" ry="8" fill="#1e293b" />
                        <circle cx="50" cy="70" r="6" fill="#f472b6" /> <!-- Nose -->
                    </svg>

                    <!-- The Pup -->
                    <div class="pup-container">
                        <svg class="pup-svg" id="pup-sprite" viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
                            <g transform="translate(10, 20)">
                                <!-- Tail -->
                                <path d="M 150 80 Q 180 80 170 120" fill="none" stroke="#f1f5f9" stroke-width="6" stroke-linecap="round"/>
                                <!-- Body -->
                                <ellipse cx="100" cy="80" rx="55" ry="35" fill="#94a3b8" />
                                <!-- Head -->
                                <ellipse cx="50" cy="75" rx="30" ry="22" fill="#94a3b8" />
                                <!-- Ear -->
                                <circle cx="60" cy="55" r="12" fill="#cbd5e1" />
                                <circle cx="60" cy="55" r="6" fill="#f1f5f9" />
                                <!-- Eye (Closed/Happy) -->
                                <path d="M 30 70 Q 40 75 50 70" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round"/>
                                <!-- Nose -->
                                <circle cx="20" cy="80" r="4" fill="#f472b6" />
                                <!-- Legs -->
                                <ellipse cx="70" cy="110" rx="12" ry="8" fill="#cbd5e1" />
                                <ellipse cx="130" cy="110" rx="12" ry="8" fill="#cbd5e1" />
                            </g>
                        </svg>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="groom-progress"></div>
                    </div>
                </div>

                <!-- Micro View: DNA -->
                <div class="micro-panel">
                    <div class="micro-header">GR GENE (DNA)</div>
                    <div class="dna-container" id="dna-container">
                        <svg class="dna-svg" id="dna-strand" viewBox="0 0 100 400" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 20 0 Q 80 100 20 200 T 20 400" fill="none" stroke="#475569" stroke-width="8" />
                            <path d="M 80 0 Q 20 100 80 200 T 80 400" fill="none" stroke="#334155" stroke-width="8" />
                            <line x1="30" y1="40" x2="70" y2="60" stroke="#475569" stroke-width="4"/>
                            <line x1="45" y1="100" x2="55" y2="100" stroke="#475569" stroke-width="4"/>
                            <line x1="70" y1="140" x2="30" y2="160" stroke="#475569" stroke-width="4"/>
                            <line x1="75" y1="200" x2="25" y2="200" stroke="#475569" stroke-width="4"/>
                            <line x1="70" y1="260" x2="30" y2="240" stroke="#475569" stroke-width="4"/>
                            <line x1="55" y1="300" x2="45" y2="300" stroke="#475569" stroke-width="4"/>
                            <line x1="30" y1="340" x2="70" y2="360" stroke="#475569" stroke-width="4"/>
                        </svg>
                        <!-- Methyl groups injected via JS -->
                    </div>
                </div>

            </div>
        </div>

        <!-- SCREEN 4: Result -->
        <div id="view-result" class="screen">
            <div class="result-card">
                <h2 id="result-title">Simulation Complete</h2>
                <p id="result-text">Result text goes here.</p>
                <div id="dashboard-return" style="display:none; margin-top: 30px;">
                    <a href="index.html" class="btn btn-secondary">üè† Return to Dashboard</a>
                </div>
                <button id="retry-btn" class="btn" onclick="startGame()" style="margin-top: 30px;">‚Üª Try Again</button>
            </div>
        </div>

    </div>

    <script>
        // --- Navigation Logic ---
        function switchView(viewId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Toggle Timer visibility
            document.getElementById('game-timer').style.display = (viewId === 'view-game') ? 'block' : 'none';
        }

        // --- Science Slides Logic ---
        let currentSlide = 1;
        const totalSlides = 3;

        function changeSlide(direction) {
            document.getElementById(`slide-${currentSlide}`).classList.remove('active');
            currentSlide += direction;
            document.getElementById(`slide-${currentSlide}`).classList.add('active');

            document.getElementById('btn-prev').style.visibility = (currentSlide === 1) ? 'hidden' : 'visible';
            
            if (currentSlide === totalSlides) {
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-play').style.display = 'inline-block';
            } else {
                document.getElementById('btn-next').style.display = 'inline-block';
                document.getElementById('btn-play').style.display = 'none';
            }
        }

        // --- Game Logic ---
        const TOTAL_METHYL_GROUPS = 8;
        const LICKS_REQUIRED_PER_METHYL = 4;
        const GAME_TIME = 20;

        let isPlaying = false;
        let timeRemaining = GAME_TIME;
        let timerInterval;
        let totalLicks = 0;
        let activeMethyls = [];
        
        // Swipe tracking variables
        let lastX = null, lastY = null;
        let lastLickTime = 0;

        const dnaContainer = document.getElementById('dna-container');
        const dnaStrand = document.getElementById('dna-strand');
        const progressBar = document.getElementById('groom-progress');
        const timerDisplay = document.getElementById('timer-display');
        const touchArea = document.getElementById('touch-area');
        const motherRat = document.getElementById('mother-rat');
        const pupSprite = document.getElementById('pup-sprite');

        function setupMethylGroups() {
            dnaContainer.querySelectorAll('.methyl-group').forEach(el => el.remove());
            activeMethyls = [];
            
            const positions = [
                { top: '10%', left: '30%' }, { top: '25%', left: '50%' },
                { top: '40%', left: '70%' }, { top: '50%', left: '20%' },
                { top: '65%', left: '40%' }, { top: '75%', left: '60%' },
                { top: '85%', left: '25%' }, { top: '90%', left: '55%' }
            ];

            for(let i=0; i<TOTAL_METHYL_GROUPS; i++) {
                let m = document.createElement('div');
                m.className = 'methyl-group';
                m.innerText = 'CH3';
                m.style.top = positions[i].top;
                m.style.left = positions[i].left;
                dnaContainer.appendChild(m);
                activeMethyls.push(m);
            }
        }

        function startGame() {
            switchView('view-game');
            timeRemaining = GAME_TIME;
            totalLicks = 0;
            isPlaying = true;
            timerDisplay.innerText = timeRemaining;
            dnaStrand.classList.remove('dna-active');
            progressBar.style.width = '0%';
            
            setupMethylGroups();

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.innerText = timeRemaining;
                if(timeRemaining <= 0) endGame(false);
            }, 1000);
        }

        function endGame(isVictory) {
            isPlaying = false;
            clearInterval(timerInterval);
            switchView('view-result');

            const title = document.getElementById('result-title');
            const text = document.getElementById('result-text');
            const returnBtn = document.getElementById('dashboard-return');
            const retryBtn = document.getElementById('retry-btn');

            if(isVictory) {
                title.innerText = "Gene Activated! üß¨";
                title.style.color = "var(--accent-green)";
                text.innerHTML = "Great job! Your grooming successfully removed the methyl blocks. The GR gene is now <strong>active</strong>!<br><br><em>Progress saved to Dashboard.</em>";
                
                try { localStorage.setItem('ratSimCompleted', 'true'); } catch(e) {}

                returnBtn.style.display = "inline-block";
                retryBtn.style.display = "none";
            } else {
                title.innerText = "Gene Suppressed üõë";
                title.style.color = "var(--accent-red)";
                text.innerHTML = "You ran out of time. The GR gene remains <strong>turned off</strong>. This rat will likely grow up anxious.";
                
                returnBtn.style.display = "none";
                retryBtn.style.display = "inline-block";
            }
        }

        // --- Swiping / Licking Mechanic ---
        function handleInteraction(e) {
            if(!isPlaying) return;
            e.preventDefault();

            let x, y;
            if(e.type.includes('touch')) {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }

            // Get coordinates relative to the touch area
            const rect = touchArea.getBoundingClientRect();
            const localX = x - rect.left;
            const localY = y - rect.top;

            // Animate mother rat head peeking down towards the swipe
            motherRat.style.transform = `translateX(-50%) translateY(0px) rotate(${(localX - rect.width/2) / 10}deg)`;

            // Check distance for swipe
            if (lastX !== null && lastY !== null) {
                let dist = Math.hypot(x - lastX, y - lastY);
                let now = Date.now();

                // Throttle licks to feel natural (min 150ms between licks, requires movement)
                if (dist > 30 && (now - lastLickTime) > 150) {
                    registerLick(localX, localY);
                    lastLickTime = now;
                    lastX = x;
                    lastY = y;
                }
            } else {
                lastX = x;
                lastY = y;
            }
        }

        function endInteraction() {
            lastX = null;
            lastY = null;
            motherRat.style.transform = `translateX(-50%) translateY(-50px)`; // Hide head
        }

        function registerLick(x, y) {
            totalLicks++;
            
            // Visuals: Cute Lick text and Saliva Drop
            createLickVisual(x, y);
            
            // Jiggle the pup
            pupSprite.style.transform = `rotate(${(Math.random() - 0.5) * 10}deg) scale(0.95)`;
            setTimeout(() => pupSprite.style.transform = 'none', 100);

            // Update Progress & DNA
            let currentCycle = totalLicks % LICKS_REQUIRED_PER_METHYL;
            if (currentCycle === 0) currentCycle = LICKS_REQUIRED_PER_METHYL;
            
            progressBar.style.width = `${(currentCycle / LICKS_REQUIRED_PER_METHYL) * 100}%`;

            if(activeMethyls.length > 0) {
                let targetMethyl = activeMethyls[activeMethyls.length - 1];
                targetMethyl.classList.add('shaking');
                setTimeout(() => targetMethyl.classList.remove('shaking'), 200);
            }

            if(totalLicks % LICKS_REQUIRED_PER_METHYL === 0) {
                progressBar.style.width = `0%`;
                if(activeMethyls.length > 0) {
                    let popped = activeMethyls.pop();
                    popped.classList.remove('shaking');
                    popped.classList.add('popping');
                    setTimeout(() => popped.remove(), 500);
                }

                if(activeMethyls.length === 0) {
                    dnaStrand.classList.add('dna-active');
                    setTimeout(() => endGame(true), 1000);
                }
            }
        }

        function createLickVisual(x, y) {
            // "Lick!" Text
            const text = document.createElement('div');
            text.className = 'lick-visual';
            text.innerText = 'Lick!';
            text.style.left = `${x}px`;
            text.style.top = `${y - 20}px`;
            touchArea.appendChild(text);
            setTimeout(() => text.remove(), 600);

            // Water drop / saliva
            const drop = document.createElement('div');
            drop.className = 'saliva-drop';
            drop.style.left = `${x + (Math.random()*40-20)}px`;
            drop.style.top = `${y}px`;
            touchArea.appendChild(drop);
            setTimeout(() => drop.remove(), 500);
        }

        // Attach event listeners for Swiping (Mouse & Touch)
        touchArea.addEventListener('touchmove', handleInteraction, {passive: false});
        touchArea.addEventListener('mousemove', handleInteraction);
        
        touchArea.addEventListener('touchend', endInteraction);
        touchArea.addEventListener('mouseup', endInteraction);
        touchArea.addEventListener('mouseleave', endInteraction);

    </script>
</body>
</html>
